@using SnowflakeProxy.Core.Services
@using SnowflakeProxy.Core.Models

<ChartComponent
    Query="@QueryString"
    Spec="@VegaSpec"
    ShowMetadata="@ShowMetadata"
    CacheTtl="@CacheTtl" />

@code {
    /// <summary>
    /// Enrollment package ID to filter by
    /// </summary>
    [Parameter] public string EnrollmentPackageId { get; set; } = "30205105-6C88-404E-8876-7E9B508259EA";

    /// <summary>
    /// Show metadata (row count, cache status)
    /// </summary>
    [Parameter] public bool ShowMetadata { get; set; } = true;

    /// <summary>
    /// Cache TTL
    /// </summary>
    [Parameter] public TimeSpan? CacheTtl { get; set; } = TimeSpan.FromMinutes(10);

    private string QueryString => $@"
        SELECT
            STEP_NUMBER,
            TOTAL_SESSIONS
        FROM DEV_DATAMART.MART.ENROLLMENT_STEPS
        WHERE ENROLLMENTPACKAGEID = '{EnrollmentPackageId}'
        ORDER BY STEP_NUMBER";

    /// <summary>
    /// Custom VegaLite specification for enrollment funnel bar chart
    /// </summary>
    private object VegaSpec => new
    {
        mark = "bar",
        encoding = new
        {
            x = new
            {
                field = "STEP_NUMBER",
                type = "ordinal",
                axis = new { title = "Step Number" }
            },
            y = new
            {
                field = "TOTAL_SESSIONS",
                type = "quantitative",
                axis = new { title = "Total Sessions" }
            }
        },
        width = 600,
        height = 400
    };
}
