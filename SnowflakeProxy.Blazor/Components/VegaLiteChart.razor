@using System.Data
@using System.Text.Json
@using System.Text.Json.Serialization
@using SnowflakeProxy.Core.Models

@if (Data != null && Spec != null)
{
    @((MarkupString)GenerateChartHtml())
}

@code {
    /// <summary>
    /// The data to visualize
    /// </summary>
    [Parameter, EditorRequired]
    public DataTable? Data { get; set; }

    /// <summary>
    /// Vega-Lite specification (JSON-serializable)
    /// </summary>
    [Parameter, EditorRequired]
    public object? Spec { get; set; }

    // Generate stable container ID once per component instance
    private readonly string _containerId = $"vis-{Guid.NewGuid():N}";

    private string GenerateChartHtml()
    {
        if (Data == null || Spec == null)
            return string.Empty;

        // Inject data into Vega-Lite spec
        var specWithData = InjectDataIntoSpec(Spec);
        return GenerateVegaLiteHtml(specWithData);
    }

    private object InjectDataIntoSpec(object customSpec)
    {
        var specJson = JsonSerializer.Serialize(customSpec);
        var specDict = JsonSerializer.Deserialize<Dictionary<string, object>>(specJson);

        if (specDict == null)
            throw new InvalidOperationException("Custom Vega-Lite spec could not be deserialized");

        var dataValues = ConvertDataTableToObjects();
        specDict["data"] = JsonSerializer.Deserialize<object>(
            JsonSerializer.Serialize(new { values = dataValues }))!;

        return specDict;
    }

    private List<Dictionary<string, object?>> ConvertDataTableToObjects()
    {
        var result = new List<Dictionary<string, object?>>();

        foreach (DataRow row in Data!.Rows)
        {
            var dict = new Dictionary<string, object?>();
            for (int i = 0; i < Data.Columns.Count; i++)
            {
                var columnName = Data.Columns[i].ColumnName;
                var value = row[i] == DBNull.Value ? null : row[i];
                dict[columnName] = value;
            }
            result.Add(dict);
        }

        return result;
    }

    private string GenerateVegaLiteHtml(object vegaLiteSpec)
    {
        var specJson = JsonSerializer.Serialize(vegaLiteSpec, new JsonSerializerOptions
        {
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
            DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
        });

        return $@"
            <div id=""{_containerId}""></div>
            <script type=""text/javascript"">
              (function() {{
                if (typeof vegaEmbed === 'undefined') {{
                  console.error('Vega-Lite not loaded. Please include vega-embed script.');
                  return;
                }}

                var spec = {specJson};
                vegaEmbed('#{_containerId}', spec, {{
                  actions: false,
                  renderer: 'svg'
                }}).catch(console.error);
              }})();
            </script>";
    }
}
