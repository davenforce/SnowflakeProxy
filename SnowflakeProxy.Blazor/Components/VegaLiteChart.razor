@using System.Data
@using System.Text.Json
@using System.Text.Json.Serialization
@using SnowflakeProxy.Core.Models
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div id="@_containerId"></div>

@code {
    /// <summary>
    /// The data to visualize
    /// </summary>
    [Parameter, EditorRequired]
    public DataTable? Data { get; set; }

    /// <summary>
    /// Vega-Lite specification (JSON-serializable)
    /// </summary>
    [Parameter, EditorRequired]
    public object? Spec { get; set; }

    // Generate stable container ID once per component instance
    private readonly string _containerId = $"vis-{Guid.NewGuid():N}";
    private bool _initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Data != null && Spec != null)
        {
            _initialized = true;
            await RenderChartAsync();
        }
    }

    private object InjectDataIntoSpec(object customSpec)
    {
        var specJson = JsonSerializer.Serialize(customSpec);
        var specDict = JsonSerializer.Deserialize<Dictionary<string, object>>(specJson);

        if (specDict == null)
            throw new InvalidOperationException("Custom Vega-Lite spec could not be deserialized");

        var dataValues = ConvertDataTableToObjects();
        specDict["data"] = JsonSerializer.Deserialize<object>(
            JsonSerializer.Serialize(new { values = dataValues }))!;

        return specDict;
    }

    private List<Dictionary<string, object?>> ConvertDataTableToObjects()
    {
        var result = new List<Dictionary<string, object?>>();

        foreach (DataRow row in Data!.Rows)
        {
            var dict = new Dictionary<string, object?>();
            for (int i = 0; i < Data.Columns.Count; i++)
            {
                var columnName = Data.Columns[i].ColumnName;
                var value = row[i] == DBNull.Value ? null : row[i];
                dict[columnName] = value;
            }
            result.Add(dict);
        }

        return result;
    }

    private async Task RenderChartAsync()
    {
        if (Data == null || Spec == null)
            return;

        var specWithData = InjectDataIntoSpec(Spec);
        var specJson = JsonSerializer.Serialize(specWithData, new JsonSerializerOptions
        {
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
            DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
        });

        await JSRuntime.InvokeVoidAsync("VegaLiteInterop.render", _containerId, specJson);
    }

    public async ValueTask DisposeAsync()
    {
        if (_initialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("VegaLiteInterop.destroy", _containerId);
            }
            catch
            {
                // Ignore errors during disposal
            }
        }
    }
}
